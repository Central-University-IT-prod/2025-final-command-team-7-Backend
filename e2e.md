# Подробное описание тестовых сценариев для FilmHub

## 1. Тесты аутентификации

### 1.1. Регистрация пользователя

**Тест успешной регистрации пользователя**
- Отправляет POST-запрос на `/api/v1/auth/register` с валидными данными (email, password, username)
- Проверяет статус-код 200
- Проверяет, что в ответе содержатся корректные данные пользователя
- Проверяет, что пользователь был создан в базе данных
- Проверяет, что для пользователя созданы стандартные списки просмотра (понравившиеся, просмотренные, хочу посмотреть)

**Тест регистрации с занятым email**
- Создаёт пользователя с определённым email
- Пытается зарегистрировать нового пользователя с тем же email
- Проверяет статус-код 409 (конфликт)
- Проверяет сообщение об ошибке "User with this email already exists"

**Тест регистрации с некорректными данными**
- Отправляет запросы регистрации с различными невалидными данными:
  - Пустой email
  - Некорректный формат email
  - Пустой пароль
  - Слишком короткий пароль
  - Пустое имя пользователя
- Проверяет статус-код 422 и соответствующие сообщения об ошибках валидации

### 1.2. Вход пользователя

**Тест входа с правильными учетными данными**
- Создаёт пользователя с заданными учетными данными
- Отправляет POST-запрос на `/api/v1/auth/login` с корректными email и password
- Проверяет статус-код 200
- Проверяет, что в ответе есть токен JWT
- Проверяет, что в ответе содержатся корректные данные пользователя
- Проверяет валидность полученного токена (использует его для доступа к защищенному ресурсу)

**Тест входа с неправильным паролем**
- Создаёт пользователя с заданными учетными данными
- Отправляет запрос на вход с правильным email, но неправильным паролем
- Проверяет статус-код 401 (не авторизован)
- Проверяет сообщение об ошибке "Invalid password"

**Тест входа с несуществующим email**
- Отправляет запрос на вход с несуществующим email
- Проверяет статус-код 401
- Проверяет сообщение об ошибке "Invalid login data"

**Тест получения профиля пользователя**
- Авторизуется как пользователь (получает токен)
- Отправляет GET-запрос на `/api/v1/me` с токеном авторизации
- Проверяет статус-код 200
- Проверяет, что данные пользователя в ответе соответствуют ожидаемым

### 1.3. Telegram авторизация

**Тест генерации токена аутентификации Telegram**
- Отправляет POST-запрос на `/api/v1/auth/telegram/get_auth_key`
- Проверяет статус-код 200
- Проверяет, что в ответе есть авторизационный ключ (auth_key)
- Проверяет, что токен был создан в базе данных со статусом неактивированного

**Тест проверки статуса токена Telegram**
- Создаёт токен аутентификации Telegram
- Отправляет POST-запрос на `/api/v1/auth/telegram/check_auth_key` с кодом токена
- Проверяет статус-код 200
- Проверяет, что в ответе поле is_confirmed установлено в false

**Тест активации токена Telegram**
- Создаёт токен аутентификации и пользователя
- Эмулирует активацию токена (вызов endpoint для активации токена с ID пользователя)
- Проверяет, что токен был привязан к пользователю и активирован

**Тест входа через активированный токен Telegram**
- Создаёт и активирует токен Telegram для конкретного пользователя
- Отправляет POST-запрос на `/api/v1/auth/telegram/login` с кодом токена
- Проверяет статус-код 200
- Проверяет, что в ответе есть JWT токен и данные пользователя
- Проверяет, что полученный токен действителен (использует его для доступа к защищенному ресурсу)

**Тест входа через неактивированный токен Telegram**
- Создаёт неактивированный токен Telegram
- Пытается использовать его для входа
- Проверяет статус-код 401
- Проверяет сообщение об ошибке "Invalid or inactive authentication token"

## 2. Тесты управления фильмами

### 2.1. Поиск и получение фильмов

**Тест поиска фильмов по названию**
- Создаёт несколько фильмов с различными названиями
- Отправляет GET-запрос на `/api/v1/films/search?title=ключевое_слово`
- Проверяет статус-код 200
- Проверяет, что в ответе содержатся только фильмы, соответствующие запросу
- Проверяет, что результаты отсортированы по релевантности
- Проверяет работу ограничения количества результатов (параметр limit)

**Тест поиска фильмов по описанию**
- Создаёт несколько фильмов с различными описаниями
- Отправляет GET-запрос на `/api/v1/films/search?description=ключевое_слово`
- Проверяет статус-код 200
- Проверяет, что в ответе содержатся только фильмы, соответствующие запросу
- Проверяет, что результаты включают фильмы, где ключевое слово встречается в описании
- Проверяет, что для поиска по описанию используется GPT-сервис

**Тест получения фильма по ID**
- Создаёт фильм
- Отправляет GET-запрос на `/api/v1/films/{film_id}`
- Проверяет статус-код 200
- Проверяет, что в ответе содержатся корректные данные фильма
- Проверяет наличие дополнительных полей (is_liked, is_wish, is_watched) для авторизованного пользователя

**Тест получения несуществующего фильма**
- Отправляет GET-запрос на `/api/v1/films/{несуществующий_id}`
- Проверяет статус-код 404
- Проверяет сообщение об ошибке "Film not found"

### 2.2. Создание и управление фильмами

**Тест создания фильма с обязательными полями**
- Авторизуется как пользователь
- Отправляет POST-запрос на `/api/v1/films` с минимальным набором полей (title, description)
- Проверяет статус-код 200
- Проверяет, что фильм создан в базе данных с корректными данными
- Проверяет, что owner_id фильма соответствует ID авторизованного пользователя

**Тест создания фильма со всеми полями**
- Авторизуется как пользователь
- Получает список доступных жанров
- Отправляет POST-запрос на `/api/v1/films` со всеми полями (title, description, genres_ids, country, release_year)
- Проверяет статус-код 200
- Проверяет, что фильм создан со всеми указанными полями
- Проверяет связи с жанрами в базе данных

**Тест обновления фильма**
- Авторизуется как пользователь
- Создаёт фильм
- Отправляет PUT-запрос на `/api/v1/films/{film_id}` с обновленными данными
- Проверяет статус-код 200
- Проверяет, что данные фильма в базе данных обновлены
- Проверяет обновление связей с жанрами

**Тест загрузки постера для фильма**
- Авторизуется как пользователь
- Создаёт фильм
- Отправляет PUT-запрос на `/api/v1/films/{film_id}/poster` с файлом изображения
- Проверяет статус-код 204 (No Content)
- Проверяет, что в базе данных обновлена ссылка на постер
- Проверяет, что файл успешно загружен в S3/MinIO

**Тест удаления постера фильма**
- Авторизуется как пользователь
- Создаёт фильм с постером
- Отправляет DELETE-запрос на `/api/v1/films/{film_id}/poster`
- Проверяет статус-код 204
- Проверяет, что ссылка на постер в базе данных очищена
- Проверяет, что файл удален из S3/MinIO

**Тест обновления чужого фильма**
- Авторизуется как первый пользователь
- Создаёт фильм
- Авторизуется как второй пользователь
- Пытается обновить фильм, созданный первым пользователем
- Проверяет статус-код 403 (Forbidden)
- Проверяет сообщение об ошибке "Film is not owned by you"

## 3. Тесты списков просмотра

### 3.1. Пользовательские списки просмотра

**Тест создания пользовательского списка просмотра**
- Авторизуется как пользователь
- Отправляет POST-запрос на `/api/v1/me/watchlists` с названием списка
- Проверяет статус-код 200
- Проверяет, что список просмотра создан в базе данных
- Проверяет, что тип списка установлен как "custom"
- Проверяет, что списку присвоены случайные цвета градиента

**Тест получения всех списков просмотра пользователя**
- Авторизуется как пользователь
- Создаёт несколько пользовательских списков просмотра
- Отправляет GET-запрос на `/api/v1/me/watchlists`
- Проверяет статус-код 200
- Проверяет, что в ответе содержатся только списки просмотра с типом "custom"
- Проверяет, что стандартные списки (liked, watched, wish) не включаются в результат

**Тест получения списка просмотра по ID**
- Авторизуется как пользователь
- Создаёт список просмотра
- Отправляет GET-запрос на `/api/v1/me/watchlists/{watchlist_id}`
- Проверяет статус-код 200
- Проверяет, что в ответе содержатся корректные данные списка просмотра

**Тест добавления фильма в пользовательский список просмотра**
- Авторизуется как пользователь
- Создаёт список просмотра и фильм
- Отправляет PUT-запрос на `/api/v1/me/watchlists/{watchlist_id}/items/add` с ID фильма
- Проверяет статус-код 204
- Проверяет, что фильм добавлен в список просмотра в базе данных

**Тест получения фильмов из пользовательского списка просмотра**
- Авторизуется как пользователь
- Создаёт список просмотра и добавляет в него несколько фильмов
- Отправляет GET-запрос на `/api/v1/me/watchlists/{watchlist_id}/items`
- Проверяет статус-код 200
- Проверяет, что в ответе содержатся все добавленные фильмы
- Проверяет, что фильмы отсортированы по дате добавления (от новых к старым)
- Проверяет, что для каждого фильма указаны флаги is_liked, is_wish, is_watched

**Тест удаления фильма из пользовательского списка просмотра**
- Авторизуется как пользователь
- Создаёт список просмотра и добавляет в него фильм
- Отправляет DELETE-запрос на `/api/v1/me/watchlists/{watchlist_id}/items/{film_id}`
- Проверяет статус-код 204
- Проверяет, что фильм удален из списка просмотра в базе данных

**Тест доступа к чужому списку просмотра**
- Авторизуется как первый пользователь
- Создаёт список просмотра
- Авторизуется как второй пользователь
- Пытается получить список просмотра, созданный первым пользователем
- Проверяет статус-код 403
- Проверяет сообщение об ошибке "Watchlist is not yours"

### 3.2. Стандартные списки просмотра

**Тест получения списка понравившихся фильмов**
- Авторизуется как пользователь
- Отправляет GET-запрос на `/api/v1/me/watchlists/liked`
- Проверяет статус-код 200
- Проверяет, что в ответе содержатся данные списка просмотра с типом "liked"

**Тест добавления фильма в список понравившихся**
- Авторизуется как пользователь
- Создаёт фильм
- Отправляет PUT-запрос на `/api/v1/me/watchlists/liked/items/add` с ID фильма
- Проверяет статус-код 204
- Проверяет, что фильм добавлен в список понравившихся в базе данных

**Тест получения понравившихся фильмов**
- Авторизуется как пользователь
- Добавляет несколько фильмов в список понравившихся
- Отправляет GET-запрос на `/api/v1/me/watchlists/liked/items`
- Проверяет статус-код 200
- Проверяет, что в ответе содержатся все добавленные фильмы
- Проверяет, что у всех фильмов флаг is_liked установлен в true

**Тест удаления фильма из списка понравившихся**
- Авторизуется как пользователь
- Добавляет фильм в список понравившихся
- Отправляет DELETE-запрос на `/api/v1/me/watchlists/liked/items/{film_id}`
- Проверяет статус-код 204
- Проверяет, что фильм удален из списка понравившихся в базе данных
- Проверяет, что при получении фильма по ID его флаг is_liked установлен в false

**Тест получения списка просмотренных фильмов**
- Авторизуется как пользователь
- Отправляет GET-запрос на `/api/v1/me/watchlists/watched`
- Проверяет статус-код 200
- Проверяет, что в ответе содержатся данные списка просмотра с типом "watched"

**Тест добавления фильма в список просмотренных**
- Авторизуется как пользователь
- Создаёт фильм
- Отправляет PUT-запрос на `/api/v1/me/watchlists/watched/items/add` с ID фильма
- Проверяет статус-код 204
- Проверяет, что фильм добавлен в список просмотренных в базе данных

**Тест получения просмотренных фильмов**
- Авторизуется как пользователь
- Добавляет несколько фильмов в список просмотренных
- Отправляет GET-запрос на `/api/v1/me/watchlists/watched/items`
- Проверяет статус-код 200
- Проверяет, что в ответе содержатся все добавленные фильмы
- Проверяет, что у всех фильмов флаг is_watched установлен в true

**Тест удаления фильма из списка просмотренных**
- Авторизуется как пользователь
- Добавляет фильм в список просмотренных
- Отправляет DELETE-запрос на `/api/v1/me/watchlists/watched/items/{film_id}`
- Проверяет статус-код 204
- Проверяет, что фильм удален из списка просмотренных в базе данных
- Проверяет, что при получении фильма по ID его флаг is_watched установлен в false

**Тест получения списка "Хочу посмотреть"**
- Авторизуется как пользователь
- Отправляет GET-запрос на `/api/v1/me/watchlists/wish`
- Проверяет статус-код 200
- Проверяет, что в ответе содержатся данные списка просмотра с типом "wish"

**Тест добавления фильма в список "Хочу посмотреть"**
- Авторизуется как пользователь
- Создаёт фильм
- Отправляет PUT-запрос на `/api/v1/me/watchlists/wish/items/add` с ID фильма
- Проверяет статус-код 204
- Проверяет, что фильм добавлен в список "Хочу посмотреть" в базе данных

**Тест получения фильмов из списка "Хочу посмотреть"**
- Авторизуется как пользователь
- Добавляет несколько фильмов в список "Хочу посмотреть"
- Отправляет GET-запрос на `/api/v1/me/watchlists/wish/items`
- Проверяет статус-код 200
- Проверяет, что в ответе содержатся все добавленные фильмы
- Проверяет, что у всех фильмов флаг is_wish установлен в true

**Тест удаления фильма из списка "Хочу посмотреть"**
- Авторизуется как пользователь
- Добавляет фильм в список "Хочу посмотреть"
- Отправляет DELETE-запрос на `/api/v1/me/watchlists/wish/items/{film_id}`
- Проверяет статус-код 204
- Проверяет, что фильм удален из списка "Хочу посмотреть" в базе данных
- Проверяет, что при получении фильма по ID его флаг is_wish установлен в false

## 4. Тесты миксов

**Тест получения всех миксов**
- Отправляет GET-запрос на `/api/v1/mix`
- Проверяет статус-код 200
- Проверяет, что в ответе содержатся все доступные миксы
- Проверяет структуру каждого микса (id, title, color1, color2, color3)

**Тест получения микса по ID**
- Отправляет GET-запрос на `/api/v1/mix/{mix_id}` для существующего микса
- Проверяет статус-код 200
- Проверяет, что в ответе содержатся корректные данные микса

**Тест получения несуществующего микса**
- Отправляет GET-запрос на `/api/v1/mix/{несуществующий_id}`
- Проверяет статус-код 404
- Проверяет сообщение об ошибке "Mix not found"

**Тест получения фильмов из микса**
- Отправляет GET-запрос на `/api/v1/mix/{mix_id}/items`
- Проверяет статус-код 200
- Проверяет, что в ответе содержатся все фильмы из микса
- Проверяет структуру каждого элемента (фильма)
- Проверяет, что для авторизованного пользователя указаны флаги is_liked, is_wish, is_watched
- Проверяет, что для неавторизованного пользователя эти флаги установлены в false

## 5. Тесты рекомендаций

**Тест рекомендации фильма по жанрам**
- Авторизуется как пользователь
- Получает список доступных жанров
- Отправляет POST-запрос на `/api/v1/recommend` с параметром genres_ids
- Проверяет статус-код 200
- Проверяет, что рекомендованный фильм соответствует указанным жанрам
- Проверяет, что рекомендация сохранена в базе данных (таблица recommended_film)

**Тест рекомендации фильма по настроениям**
- Авторизуется как пользователь
- Получает список доступных настроений
- Отправляет POST-запрос на `/api/v1/recommend` с параметром moods_ids
- Проверяет статус-код 200
- Проверяет, что рекомендованный фильм соответствует жанрам, связанным с указанными настроениями

**Тест отсутствия повторных рекомендаций**
- Авторизуется как пользователь
- Получает первую рекомендацию
- Получает вторую рекомендацию с теми же параметрами
- Проверяет, что рекомендованные фильмы различаются
- Повторяет несколько раз и проверяет, что недавно рекомендованные фильмы не рекомендуются повторно

**Тест рекомендации с параметром типа контента**
- Авторизуется как пользователь
- Отправляет POST-запрос на `/api/v1/recommend` с параметром movie_type="movie"
- Проверяет, что рекомендован фильм
- Отправляет POST-запрос на `/api/v1/recommend` с параметром movie_type="tv"
- Проверяет, что рекомендован сериал

**Тест добавления рекомендованного фильма в списки просмотра**
- Авторизуется как пользователь
- Получает рекомендацию фильма
- Добавляет рекомендованный фильм в различные списки просмотра
- Проверяет, что фильм успешно добавлен в каждый список

## 6. Тесты жанров и настроений

**Тест получения всех жанров**
- Отправляет GET-запрос на `/api/v1/genres`
- Проверяет статус-код 200
- Проверяет, что в ответе содержатся все доступные жанры
- Проверяет структуру каждого жанра (id, name)

**Тест получения жанра по ID**
- Отправляет GET-запрос на `/api/v1/genres/{genre_id}` для существующего жанра
- Проверяет статус-код 200
- Проверяет, что в ответе содержатся корректные данные жанра

**Тест получения несуществующего жанра**
- Отправляет GET-запрос на `/api/v1/genres/{несуществующий_id}`
- Проверяет статус-код 404
- Проверяет сообщение об ошибке "Genre not found"

**Тест фильтрации жанров по настроениям**
- Получает список доступных настроений
- Отправляет GET-запрос на `/api/v1/genres?moods_ids={mood_id1},{mood_id2}`
- Проверяет статус-код 200
- Проверяет, что в результате только жанры, связанные с указанными настроениями

**Тест получения всех настроений**
- Отправляет GET-запрос на `/api/v1/moods`
- Проверяет статус-код 200
- Проверяет, что в ответе содержатся все доступные настроения
- Проверяет структуру каждого настроения (id, name)

**Тест получения настроения по ID**
- Отправляет GET-запрос на `/api/v1/moods/{mood_id}` для существующего настроения
- Проверяет статус-код 200
- Проверяет, что в ответе содержатся корректные данные настроения

**Тест получения несуществующего настроения**
- Отправляет GET-запрос на `/api/v1/moods/{несуществующий_id}`
- Проверяет статус-код 404
- Проверяет сообщение об ошибке "Mood not found"

## 7. Интеграционные тесты внешних сервисов

### 7.1. Интеграция с TMDB

**Тест поиска фильмов через TMDB API**
- Эмулирует ответ TMDB API с фиктивными данными
- Отправляет GET-запрос на поиск фильмов
- Проверяет, что результаты поиска корректно обрабатываются
- Проверяет, что фильмы сохраняются в локальной базе данных

**Тест обработки данных фильма из TMDB**
- Эмулирует ответ TMDB API с подробными данными о фильме
- Проверяет, что данные корректно преобразуются в формат приложения
- Проверяет, что формируются правильные URL для постеров
- Проверяет, что корректно извлекается год выпуска из даты

**Тест обработки ошибок TMDB API**
- Эмулирует различные ошибки TMDB API (таймаут, ошибка 404, ошибка 500)
- Проверяет, что приложение корректно обрабатывает эти ошибки
- Проверяет, что пользователю возвращаются понятные сообщения об ошибках

### 7.2. Интеграция с GPT

**Тест определения фильмов по описанию через GPT**
- Эмулирует запрос к GPT API с описанием фильма
- Эмулирует ответ GPT API с предполагаемыми названиями фильмов
- Проверяет, что результаты корректно обрабатываются
- Проверяет, что запросы к TMDB выполняются для найденных названий

**Тест генерации цветов градиента для микса**
- Эмулирует запрос к GPT API для генерации цветов на основе названия микса
- Эмулирует ответ GPT API с цветами в формате HEX
- Проверяет, что цвета корректно применяются к миксу

**Тест обработки ошибок GPT API**
- Эмулирует различные ошибки GPT API
- Проверяет, что приложение корректно обрабатывает эти ошибки
- Проверяет, что используются значения по умолчанию в случае ошибок

### 7.3. Интеграция с S3/MinIO

**Тест загрузки файла в S3**
- Эмулирует запрос на загрузку файла
- Проверяет, что файл корректно загружается в S3
- Проверяет, что возвращается правильный URL для доступа к файлу

**Тест получения файла из S3**
- Эмулирует загрузку файла в S3
- Проверяет, что файл доступен по сгенерированному URL

**Тест удаления файла из S3**
- Эмулирует загрузку файла в S3
- Выполняет запрос на удаление файла
- Проверяет, что файл успешно удален из S3

**Тест обработки ошибок S3**
- Эмулирует различные ошибки S3 (недоступность сервиса, ошибка авторизации)
- Проверяет, что приложение корректно обрабатывает эти ошибки
- Проверяет, что пользователю возвращаются понятные сообщения об ошибках
